{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nimport { isNullOrUndefined, extend } from '@syncfusion/ej2-base';\nimport { DataManager, Query, Deferred, Predicate, DataUtil } from '@syncfusion/ej2-data';\nimport { initForeignKeyColumn, getForeignKeyData, generateQuery } from '../base/constant';\nimport { getDatePredicate } from '../base/util';\nimport { Data } from './data';\nimport * as events from '../base/constant';\n/**\n * `ForeignKey` module is used to handle foreign key column's actions.\n */\n\nvar ForeignKey =\n/** @class */\nfunction (_super) {\n  __extends(ForeignKey, _super);\n\n  function ForeignKey(parent, serviceLocator) {\n    var _this = _super.call(this, parent, serviceLocator) || this;\n\n    _this.parent = parent;\n    _this.serviceLocator = serviceLocator;\n\n    _this.initEvent();\n\n    return _this;\n  }\n\n  ForeignKey.prototype.initEvent = function () {\n    if (this.parent.isDestroyed) {\n      return;\n    }\n\n    this.parent.on(initForeignKeyColumn, this.initForeignKeyColumns, this);\n    this.parent.on(getForeignKeyData, this.getForeignKeyData, this);\n    this.parent.on(generateQuery, this.generateQueryFormData, this);\n  };\n\n  ForeignKey.prototype.initForeignKeyColumns = function (columns) {\n    for (var i = 0; i < columns.length; i++) {\n      columns[i].dataSource = columns[i].dataSource instanceof DataManager ? columns[i].dataSource : isNullOrUndefined(columns[i].dataSource) ? new DataManager() : 'result' in columns[i].dataSource ? columns[i].dataSource : new DataManager(columns[i].dataSource);\n    }\n  };\n\n  ForeignKey.prototype.eventfPromise = function (args, query, key, column) {\n    var state = this.getStateEventArgument(query);\n    var def = new Deferred();\n    var deff = new Deferred();\n    state.action = args.action;\n    var dataModule = this.parent.getDataModule();\n\n    if (!isNullOrUndefined(args.action) && args.action.requestType && dataModule.foreignKeyDataState.isDataChanged !== false) {\n      dataModule.setForeignKeyDataState({\n        isPending: true,\n        resolver: deff.resolve\n      });\n      deff.promise.then(function () {\n        def.resolve(column.dataSource);\n      });\n      state.setColumnData = this.parent.setForeignKeyData.bind(this.parent);\n      this.parent.trigger(events.columnDataStateChange, state);\n    } else {\n      dataModule.setForeignKeyDataState({});\n      def.resolve(key);\n    }\n\n    return def;\n  };\n\n  ForeignKey.prototype.getForeignKeyData = function (args) {\n    var _this = this;\n\n    var foreignColumns = args.column ? [args.column] : this.parent.getForeignKeyColumns();\n    var allPromise = [];\n\n    var _loop_1 = function (i) {\n      var promise = void 0;\n      var query = args.isComplex ? this_1.genarateColumnQuery(foreignColumns[i]) : this_1.genarateQuery(foreignColumns[i], args.result.result, false, true);\n      query.params = this_1.parent.query.params;\n      var dataSource = foreignColumns[i].dataSource;\n\n      if (dataSource && 'result' in dataSource) {\n        var def = this_1.eventfPromise(args, query, dataSource, foreignColumns[i]);\n        promise = def.promise;\n      } else if (!dataSource.ready || dataSource.dataSource.offline) {\n        promise = dataSource.executeQuery(query);\n      } else {\n        promise = dataSource.ready.then(function () {\n          return dataSource.executeQuery(query);\n        });\n      }\n\n      allPromise.push(promise);\n    };\n\n    var this_1 = this;\n\n    for (var i = 0; i < foreignColumns.length; i++) {\n      _loop_1(i);\n    }\n\n    Promise.all(allPromise).then(function (responses) {\n      for (var i = 0; i < responses.length; i++) {\n        foreignColumns[i].columnData = responses[i].result;\n\n        if (foreignColumns[i].editType === 'dropdownedit' && 'result' in foreignColumns[i].dataSource) {\n          foreignColumns[i].edit.params = extend(foreignColumns[i].edit.params, {\n            dataSource: responses[i].result,\n            query: new Query(),\n            fields: {\n              value: foreignColumns[i].foreignKeyField || foreignColumns[i].field,\n              text: foreignColumns[i].foreignKeyValue\n            }\n          });\n        }\n      }\n\n      args.promise.resolve(args.result);\n    }).catch(function (e) {\n      _this.parent.log(['actionfailure', 'foreign_key_failure']);\n\n      if (args.promise && args.promise.reject) {\n        args.promise.reject(e);\n      }\n\n      return e;\n    });\n  };\n\n  ForeignKey.prototype.generateQueryFormData = function (args) {\n    args.predicate.predicate = this.genarateQuery(args.column, args.column.columnData, true);\n  };\n\n  ForeignKey.prototype.genarateQuery = function (column, e, fromData, needQuery) {\n    var gObj = this.parent;\n    var predicates = [];\n    var query = new Query();\n    var field = fromData ? column.foreignKeyField : column.field;\n\n    if (gObj.allowPaging || gObj.enableVirtualization || fromData) {\n      e = new DataManager(gObj.allowGrouping && gObj.groupSettings.columns.length && !fromData ? e.records : e).executeLocal(new Query().select(field));\n      var filteredValue = DataUtil.distinct(e, field, false);\n      field = fromData ? column.field : column.foreignKeyField;\n\n      for (var i = 0; i < filteredValue.length; i++) {\n        if (filteredValue[i] && filteredValue[i].getDay) {\n          predicates.push(getDatePredicate({\n            field: field,\n            operator: 'equal',\n            value: filteredValue[i],\n            matchCase: false\n          }));\n        } else {\n          predicates.push(new Predicate(field, 'equal', filteredValue[i], false));\n        }\n      }\n    }\n\n    if (needQuery) {\n      return predicates.length ? query.where(Predicate.or(predicates)) : query;\n    }\n\n    return predicates.length ? Predicate.or(predicates) : {\n      predicates: []\n    };\n  };\n\n  ForeignKey.prototype.genarateColumnQuery = function (column) {\n    var gObj = this.parent;\n    var query = new Query();\n    var queryColumn = this.isFiltered(column);\n\n    if (queryColumn.isTrue) {\n      query = this.filterQuery(query, queryColumn.column, true);\n    }\n\n    if (gObj.searchSettings.key.length) {\n      var sSettings = gObj.searchSettings;\n\n      if (column.dataSource instanceof DataManager && column.dataSource.adaptor.getModuleName && column.dataSource.adaptor.getModuleName() === 'ODataV4Adaptor') {\n        query = this.searchQuery(query, column, true);\n      } else {\n        query.search(sSettings.key, column.foreignKeyValue, sSettings.operator, sSettings.ignoreCase);\n      }\n    }\n\n    return query;\n  };\n\n  ForeignKey.prototype.isFiltered = function (column) {\n    var filterColumn = this.parent.filterSettings.columns.filter(function (fColumn) {\n      return fColumn.field === column.foreignKeyValue && fColumn.uid === column.uid;\n    });\n    return {\n      column: filterColumn,\n      isTrue: !!filterColumn.length\n    };\n  };\n\n  ForeignKey.prototype.getModuleName = function () {\n    return 'foreignKey';\n  };\n\n  ForeignKey.prototype.destroy = function () {\n    this.destroyEvent();\n  };\n\n  ForeignKey.prototype.destroyEvent = function () {\n    if (this.parent.isDestroyed) {\n      return;\n    }\n\n    this.parent.off(initForeignKeyColumn, this.initForeignKeyColumns);\n    this.parent.off(getForeignKeyData, this.getForeignKeyData);\n    this.parent.off(generateQuery, this.generateQueryFormData);\n  };\n\n  return ForeignKey;\n}(Data);\n\nexport { ForeignKey };","map":{"version":3,"sources":["/Users/yasaman/Documents/moj_adminpanel/adminpanel/node_modules/@syncfusion/ej2-grids/src/grid/actions/foreign-key.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","isNullOrUndefined","extend","DataManager","Query","Deferred","Predicate","DataUtil","initForeignKeyColumn","getForeignKeyData","generateQuery","getDatePredicate","Data","events","ForeignKey","_super","parent","serviceLocator","_this","call","initEvent","isDestroyed","on","initForeignKeyColumns","generateQueryFormData","columns","i","length","dataSource","eventfPromise","args","query","key","column","state","getStateEventArgument","def","deff","action","dataModule","getDataModule","requestType","foreignKeyDataState","isDataChanged","setForeignKeyDataState","isPending","resolver","resolve","promise","then","setColumnData","setForeignKeyData","bind","trigger","columnDataStateChange","foreignColumns","getForeignKeyColumns","allPromise","_loop_1","isComplex","this_1","genarateColumnQuery","genarateQuery","result","params","ready","offline","executeQuery","push","Promise","all","responses","columnData","editType","edit","fields","value","foreignKeyField","field","text","foreignKeyValue","catch","e","log","reject","predicate","fromData","needQuery","gObj","predicates","allowPaging","enableVirtualization","allowGrouping","groupSettings","records","executeLocal","select","filteredValue","distinct","getDay","operator","matchCase","where","or","queryColumn","isFiltered","isTrue","filterQuery","searchSettings","sSettings","adaptor","getModuleName","searchQuery","search","ignoreCase","filterColumn","filterSettings","filter","fColumn","uid","destroy","destroyEvent","off"],"mappings":"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","sourcesContent":["var __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nimport { isNullOrUndefined, extend } from '@syncfusion/ej2-base';\nimport { DataManager, Query, Deferred, Predicate, DataUtil } from '@syncfusion/ej2-data';\nimport { initForeignKeyColumn, getForeignKeyData, generateQuery } from '../base/constant';\nimport { getDatePredicate } from '../base/util';\nimport { Data } from './data';\nimport * as events from '../base/constant';\n/**\n * `ForeignKey` module is used to handle foreign key column's actions.\n */\nvar ForeignKey = /** @class */ (function (_super) {\n    __extends(ForeignKey, _super);\n    function ForeignKey(parent, serviceLocator) {\n        var _this = _super.call(this, parent, serviceLocator) || this;\n        _this.parent = parent;\n        _this.serviceLocator = serviceLocator;\n        _this.initEvent();\n        return _this;\n    }\n    ForeignKey.prototype.initEvent = function () {\n        if (this.parent.isDestroyed) {\n            return;\n        }\n        this.parent.on(initForeignKeyColumn, this.initForeignKeyColumns, this);\n        this.parent.on(getForeignKeyData, this.getForeignKeyData, this);\n        this.parent.on(generateQuery, this.generateQueryFormData, this);\n    };\n    ForeignKey.prototype.initForeignKeyColumns = function (columns) {\n        for (var i = 0; i < columns.length; i++) {\n            columns[i].dataSource = (columns[i].dataSource instanceof DataManager ? columns[i].dataSource :\n                (isNullOrUndefined(columns[i].dataSource) ? new DataManager() : 'result' in columns[i].dataSource ? columns[i].dataSource :\n                    new DataManager(columns[i].dataSource)));\n        }\n    };\n    ForeignKey.prototype.eventfPromise = function (args, query, key, column) {\n        var state = this.getStateEventArgument(query);\n        var def = new Deferred();\n        var deff = new Deferred();\n        state.action = args.action;\n        var dataModule = this.parent.getDataModule();\n        if (!isNullOrUndefined(args.action) && args.action.requestType && dataModule.foreignKeyDataState.isDataChanged !== false) {\n            dataModule.setForeignKeyDataState({\n                isPending: true, resolver: deff.resolve\n            });\n            deff.promise.then(function () {\n                def.resolve(column.dataSource);\n            });\n            state.setColumnData = this.parent.setForeignKeyData.bind(this.parent);\n            this.parent.trigger(events.columnDataStateChange, state);\n        }\n        else {\n            dataModule.setForeignKeyDataState({});\n            def.resolve(key);\n        }\n        return def;\n    };\n    ForeignKey.prototype.getForeignKeyData = function (args) {\n        var _this = this;\n        var foreignColumns = args.column ? [args.column] : this.parent.getForeignKeyColumns();\n        var allPromise = [];\n        var _loop_1 = function (i) {\n            var promise = void 0;\n            var query = args.isComplex ? this_1.genarateColumnQuery(foreignColumns[i]) :\n                this_1.genarateQuery(foreignColumns[i], args.result.result, false, true);\n            query.params = this_1.parent.query.params;\n            var dataSource = foreignColumns[i].dataSource;\n            if (dataSource && 'result' in dataSource) {\n                var def = this_1.eventfPromise(args, query, dataSource, foreignColumns[i]);\n                promise = def.promise;\n            }\n            else if (!dataSource.ready || dataSource.dataSource.offline) {\n                promise = dataSource.executeQuery(query);\n            }\n            else {\n                promise = dataSource.ready.then(function () {\n                    return dataSource.executeQuery(query);\n                });\n            }\n            allPromise.push(promise);\n        };\n        var this_1 = this;\n        for (var i = 0; i < foreignColumns.length; i++) {\n            _loop_1(i);\n        }\n        Promise.all(allPromise).then(function (responses) {\n            for (var i = 0; i < responses.length; i++) {\n                foreignColumns[i].columnData = responses[i].result;\n                if (foreignColumns[i].editType === 'dropdownedit' && 'result' in foreignColumns[i].dataSource) {\n                    foreignColumns[i].edit.params = extend(foreignColumns[i].edit.params, {\n                        dataSource: responses[i].result,\n                        query: new Query(), fields: {\n                            value: foreignColumns[i].foreignKeyField || foreignColumns[i].field,\n                            text: foreignColumns[i].foreignKeyValue\n                        }\n                    });\n                }\n            }\n            args.promise.resolve(args.result);\n        }).catch(function (e) {\n            _this.parent.log(['actionfailure', 'foreign_key_failure']);\n            if (args.promise && args.promise.reject) {\n                args.promise.reject(e);\n            }\n            return e;\n        });\n    };\n    ForeignKey.prototype.generateQueryFormData = function (args) {\n        args.predicate.predicate = this.genarateQuery(args.column, args.column.columnData, true);\n    };\n    ForeignKey.prototype.genarateQuery = function (column, e, fromData, needQuery) {\n        var gObj = this.parent;\n        var predicates = [];\n        var query = new Query();\n        var field = fromData ? column.foreignKeyField : column.field;\n        if (gObj.allowPaging || gObj.enableVirtualization || fromData) {\n            e = new DataManager(((gObj.allowGrouping && gObj.groupSettings.columns.length && !fromData) ?\n                e.records : e)).executeLocal(new Query().select(field));\n            var filteredValue = DataUtil.distinct(e, field, false);\n            field = fromData ? column.field : column.foreignKeyField;\n            for (var i = 0; i < filteredValue.length; i++) {\n                if (filteredValue[i] && filteredValue[i].getDay) {\n                    predicates.push(getDatePredicate({ field: field, operator: 'equal', value: filteredValue[i], matchCase: false }));\n                }\n                else {\n                    predicates.push(new Predicate(field, 'equal', filteredValue[i], false));\n                }\n            }\n        }\n        if (needQuery) {\n            return predicates.length ? query.where(Predicate.or(predicates)) : query;\n        }\n        return (predicates.length ? Predicate.or(predicates) : { predicates: [] });\n    };\n    ForeignKey.prototype.genarateColumnQuery = function (column) {\n        var gObj = this.parent;\n        var query = new Query();\n        var queryColumn = this.isFiltered(column);\n        if (queryColumn.isTrue) {\n            query = this.filterQuery(query, queryColumn.column, true);\n        }\n        if (gObj.searchSettings.key.length) {\n            var sSettings = gObj.searchSettings;\n            if (column.dataSource instanceof DataManager && (column.dataSource.adaptor.getModuleName &&\n                column.dataSource.adaptor.getModuleName() === 'ODataV4Adaptor')) {\n                query = this.searchQuery(query, column, true);\n            }\n            else {\n                query.search(sSettings.key, column.foreignKeyValue, sSettings.operator, sSettings.ignoreCase);\n            }\n        }\n        return query;\n    };\n    ForeignKey.prototype.isFiltered = function (column) {\n        var filterColumn = this.parent.filterSettings.columns.filter(function (fColumn) {\n            return (fColumn.field === column.foreignKeyValue && fColumn.uid === column.uid);\n        });\n        return {\n            column: filterColumn, isTrue: !!filterColumn.length\n        };\n    };\n    ForeignKey.prototype.getModuleName = function () {\n        return 'foreignKey';\n    };\n    ForeignKey.prototype.destroy = function () {\n        this.destroyEvent();\n    };\n    ForeignKey.prototype.destroyEvent = function () {\n        if (this.parent.isDestroyed) {\n            return;\n        }\n        this.parent.off(initForeignKeyColumn, this.initForeignKeyColumns);\n        this.parent.off(getForeignKeyData, this.getForeignKeyData);\n        this.parent.off(generateQuery, this.generateQueryFormData);\n    };\n    return ForeignKey;\n}(Data));\nexport { ForeignKey };\n"]},"metadata":{},"sourceType":"module"}